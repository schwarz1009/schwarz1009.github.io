<!DOCTYPE html>
<html dir="ltr" lang="ja">
    <head>
        <title>クロージャ・無名関数・関数オブジェクトの世界観 - from Assy</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="keywords" content="Assy,アッシー,詩,小説,物語,歴史,政治,経済,コンピュータ,パソコン,Linux,エッセイ,散文,哲学">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="../../css/style.css">
        <link rel="stylesheet" href="../../css/prettify.css" type="text/css">


<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
<link rel="manifest" href="/favicons/manifest.json">
<link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#5bbad5">
<meta name="theme-color" content="#ffffff">

    </head>
    <body>
<div class="page">
<script type="text/javascript" src="../../js/jquery.min.js"></script>
<script type="text/javascript" src="../../js/script_smartmenus.js"></script>
<script type="text/javascript" src="../../js/links2.js"></script>

<p><a href="index.html">プログラミング言語の世界観に戻る</a></p>
<div class="sidebar">
<iframe src="../../menus/prog_lang_skill_menu.html" class="sideiframe"></iframe>
</div>
<h1>クロージャ・無名関数・関数オブジェクトの世界観</h1>
<p>クロージャ・無名関数・関数オブジェクトに関する世界観です。<a href="functional_programming.html">関数型プログラミング</a>も参照のこと。</p>
<div id="toc"></div>
<div class="page_links">

<h1>クロージャ</h1>
<h2>クロージャと無名関数</h2>
<p>クロージャは、JavaScriptやRubyでおなじみの、関数を定義したスコープにある変数を使用できる関数のこと。</p>
<p>関数の定義されたのと同一スコープに定義されたローカル変数に、関数の内部からアクセスするような関数のことを、クロージャと呼ぶ。</p>
<p>Lispのような関数型言語の考え方である。上手く使うことで、簡易オブジェクト指向（さまざまな関数から共通のデータを参照する）のような使い方もできる。</p>
<p>一部の言語では、クロージャを無名関数やラムダ式で行っている。無名関数は、昔デリゲートなどと呼ばれてC#などで提供されていたこともあり、C#ではWindows.Formsのイベントにメソッドを登録する際に無名関数は便利である。</p>
<p>たとえば、</p>
<pre class="prettyprint">
function f() {
    var value = 1;
    function g() {
        console.log(value);
    }
    g();
    value = 3;
    g();
}

f();
</pre>
<p>実行結果：</p>
<pre>
1
3
</pre>
<p>このような時、g()は同じスコープにある変数valueを参照するクロージャであり、valueの値は後々になって変えることもできる。</p>
<p>また、</p>
<pre class="prettyprint">
var f = function() {
    var value = 0;
    return function g(number) {
        value += number;
        console.log(value);
    };
};

add = f();
add(3);
add(6);
</pre>
<p>実行結果：</p>
<pre>
3
9
</pre>
<p>このように、関数から関数を返し、この関数をクロージャとして使うこともできる。変数valueの値はクロージャとともに保持される。</p>
<ul>
<li><a href="https://qiita.com/takeharu/items/4975031faf6f7baf077a">JavaScriptでクロージャ入門。関数はすべてクロージャ？ - Qiita</a></li>
<li><a href="https://www.sejuku.net/blog/25026">【JavaScript入門】クロージャって一体何？使い方まで徹底解説 | 侍エンジニアブログ</a></li>
</ul>

<h2>状態</h2>
<p><a href="state.html">状態</a>も参照のこと。</p>

<h1>関数オブジェクト</h1>
<h2>デリゲート、関数オブジェクト、lambda式など</h2>
<p>関数型プログラミングでは、デリゲートや関数オブジェクト、lambda式などの「関数から関数を呼び出すシステム」が存在する。</p>
<p>デリゲートとは「委譲する」という意味で、関数を別の場所から間接的に呼び出すことのできるシステム。</p>
<p>関数オブジェクト（functor）は、関数に対して関数を与えるデリゲートと同様の仕組み。なんのために使うかといえば、やねうらお氏の「<a href="https://www.amazon.co.jp/Windows%E3%83%97%E3%83%AD%E3%83%95%E3%82%A7%E3%83%83%E3%82%B7%E3%83%A7%E3%83%8A%E3%83%AB%E3%82%B2%E3%83%BC%E3%83%A0%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B02%E3%80%90CD-ROM%E4%BB%98%E3%80%91-Game-developer-books-%E3%81%86%E3%82%89%E3%81%8A/dp/4798006033">Windowsプロフェッショナルゲームプログラミング2</a>」で述べられているように、C++のrandam_shuffleは乱数生成アルゴリズムとしてデフォルトではrand()が呼び出されるが、この部分だけをカスタマイズする、すなわちrand()ではなく別の関数を呼び出させるように関数に別の「関数オブジェクトを与える」という使い方をする。</p>
<p>僕個人のアイデアとして、たとえば「関数によって返される関数オブジェクトを関数の引数に与える」という、まるでLispハッカーのような考え方もできる。xが1でyが2であるときは1+2を返し、2と3であるときは2+3を返すような「x+yの足し算」を行う関数や、それを単純に足し算から引き算、掛け算、割り算、あるいは累乗や平方根の計算結果を返すような、まるで「関数なんでも生成器」のような関数オブジェクトとして実行可能な関数を戻り値として返す関数を作り、その関数に名前をつけることなく、即座に別の関数に「この関数生成器で作られた関数を使って計算してね」という風にプログラミングを行うことができる。たとえば「スタックにある全てのデータに対して再帰的に処理をする関数」を作り、この関数に関数オブジェクトを「具体的に処理する内容」として引数に与えることもできる。関数オブジェクトは名前のついた関数だけではなく、関数オブジェクトを返す関数によって返された関数オブジェクトでも構わない。</p>
<p>関数オブジェクトは、functorと呼ばれるほかにlambdaとも呼ばれる。functorという言葉は、operator ()をオーバーロードしたクラスを指す際にも使われる言葉であり、Lispなど関数型言語ではlambdaという言葉の方が馴染み深いかもしれない。単なる無名関数だとか、関数表現の縮小形と思っている人も多いかもしれないが、Lispではめちゃくちゃ使える機能であるとして、Lispハッカーのポール・グレアムも「C++を知るとBASICが使いづらく感じるようになるように、Lispを知るとC++が使いづらく感じるようになる」と言っている。</p>
<p>詳しくは以下の書籍が参考になります。</p>
<ul>
<li><a href="https://www.amazon.co.jp/ANSI-Common-Lisp-%E3%82%B9%E3%82%BF%E3%83%B3%E3%83%80%E3%83%BC%E3%83%89%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88-%E3%82%B0%E3%83%AC%E3%82%A2%E3%83%A0/dp/4894714337">ANSI Common Lisp (スタンダードテキスト)</a></li>
<li>やねうらお氏の「<a href="https://www.amazon.co.jp/Windows%E3%83%97%E3%83%AD%E3%83%95%E3%82%A7%E3%83%83%E3%82%B7%E3%83%A7%E3%83%8A%E3%83%AB%E3%82%B2%E3%83%BC%E3%83%A0%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0-%E3%82%84%E3%81%AD-%E3%81%86%E3%82%89%E3%81%8A/dp/479800314X">Windowsプロフェッショナルゲームプログラミング</a>」「<a href="https://www.amazon.co.jp/Windows%E3%83%97%E3%83%AD%E3%83%95%E3%82%A7%E3%83%83%E3%82%B7%E3%83%A7%E3%83%8A%E3%83%AB%E3%82%B2%E3%83%BC%E3%83%A0%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B02%E3%80%90CD-ROM%E4%BB%98%E3%80%91-Game-developer-books-%E3%81%86%E3%82%89%E3%81%8A/dp/4798006033">Windowsプロフェッショナルゲームプログラミング2</a>」</li>
</ul>

<h2>関数をデータとして扱えると、いいことがたくさんある</h2>
<p>実際のところ、プログラミングにおいて、関数すなわちコードブロックをデータとして扱えると、いいことがたくさんあります。</p>
<p>C言語では、関数ポインタなどの例外的方法を使わない限り、関数をデータとして扱うことができません。</p>
<p>ですが、Lispなどの関数型言語では、関数をデータとして扱うことができます。</p>
<p>関数をデータとして扱えると、たとえば「関数に関数を指定して引数として渡す」ということができます。このような処理を関数に対してお願いする、すなわち「委譲」することができます。</p>
<p>この結果、コールバック関数やイベントなどに基づく非同期処理、map()のような高階関数を用いることができます。</p>
<p>このような方法は、GUIのようなイベント処理を用いる技術や、OpenGLのようなグラフィックス技術、あるいは並列処理、非同期処理を用いるネットワークサーバーなどでも、よく使われる方法です。</p>
<p>そもそも、C言語のプログラムは、コマンドで使うことを基本的なスタイルとしていますが、コマンドを常に同期実行するということは、プログラミング全体から言えば多くはありません。</p>
<p>C言語ではなないC++では、テンプレートを使った汎用関数や汎用クラスだけではなく、STLのコンテナやイテレータやアルゴリズム、そして関数オブジェクトの機能を搭載しています。</p>
<p>C++/STLの機能の目的は、こうした「関数をデータとして扱う」ということを、「型を汎用的に扱う」ということと一緒にして、「どんな型やどんなコードブロックであっても後々から指定できるようにしよう」という意図があると思います。</p>
<p>関数をデータとして扱うことで、ポインタで同じデータにアクセスするだけではなく、関数オブジェクトによって同じコードブロックにアクセスできます。ポインタでデータを後々になって渡し、同じデータにアクセス・操作するだけではなく、関数オブジェクトによって、同じコードブロックにアクセス・操作できます。後々になって定義したデータやコードブロックを渡すこともできます。</p>
<p>これはGUIのイベント駆動プログラミングでは、「ボタンやメニューがクリックされたらこのコールバック関数を実行してほしい」と後々からお願いをするという意味で、非常に有用です。ネットワークサーバー、たとえばNode.jsなどでも、「このようなリクエストが来たらこのコールバック関数を実行してほしい」という風に、同様に有用です。</p>

<h2>関数にコードブロックを与えることができないのはおかしい</h2>
<p>僕の自論として、関数にコードブロックを与えることができないのはおかしいと僕は信じています。</p>
<p>関数には、自らの記述したコードブロックを、それを適切な場所で実行するための無名関数として、与えられるべきであると僕は信じています。</p>
<p>たとえば、Rubyなどではブロックを用いることで、関数にコードブロックを与えることができますが、それこそが正しい言語です。</p>
<p>昔C#で使われていたデリゲートなども同様で、僕はかつてよりそのような関数にコードブロックを与えることのできるRubyやC#の大ファンでした。</p>
<p>逆に、そのような使い方が制限される、C言語の関数ポインタのようなものを僕は好みません。Lispほどの抽象化ではなくとも、関数にコードブロックを与えることは言語にとって必須要素だと感じています。</p>
<p>真に汎用的な言語を作るためには、関数にコードブロックを与えることが許されていなければならないのです。</p>
<p>たとえば、GUIプログラミングにおいて、メソッドはイベントに紐づけることができますが、そのような場合にも、無名関数あるいはブロックを用いてイベントにメソッドを紐づけられるべきなのです。</p>
<p>「関数として名前を付ければいいじゃないか」と思われる人もいるでしょうが、「コードブロックには名前を必ず付けなければならない」というルールはおかしいのです。コードブロックに名前がないということは僕にとって直感的な感覚要素であり、コードブロックにすべて名前を付けなければならないような言語は僕は嫌いです。名前を付けるべきなのはコードブロックを与える関数のほうであり、コードブロックのほうにも名前を付けなければならないのは僕は違和感があります。</p>
<p>ただし、自らの独自の関数を、名前を付けて宣言すること自体は僕は嫌いではありません。なぜなら、「自分の名前で自分の関数を作る」ということができるということは、「言語の拡張」に繋がります。すなわち、言語をそのまま使うのではなく、自らの作った独自の関数を使って、言語そのものを拡張できます。あるいは、そこまで言わなくても、「自分の独自の便利に呼び出せる関数を作る」ということはプログラミングの基本であり、それこそがまさに「プログラミングの愉しい点」であると言えるでしょう。</p>
<p>そして、そのような関数に対して、いつでも任意のコードブロックを与えられるようにすることが、真に「汎用的な文法要素を作る」ということ、すなわち、「言語を拡張する」ということに繋がるのです。</p>
<p>たとえば、if文やfor文を使う時に、わざわざ内部のブロックに名前は付けませんよね。if文やfor文のキーワードとして「if」とか「for」というキーワードや識別子は使いますが、その内部のブロックには名前は付けません。プログラミングとはそういうものであり、コードブロックには名前を付けず、コードブロックを与える関数のほうを名前を指定して呼び出すべきなのです。</p>
<div class="edit_date">
<p>2024.06.18</p>
</div>



</div></div> <!--page-->










<script type="text/javascript" src="../../js/jquery.toc.js"></script>
<script type="text/javascript" src="../../js/script.js"></script>
<script type="text/javascript" src="../../js/scriptfortoc.js"></script>
<script type="text/javascript" src="../../js/prettify.js"></script>
<script>prettyPrint();</script>
</body>
</html>